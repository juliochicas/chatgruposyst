map $http_accept $backend_upstream {
    default "http://backend:8080";
    "~text/html" "http://frontend:80";
}

# ─── Redirect HTTP to HTTPS (all domains) ───
server {
    listen 80;
    server_name chateaya.app www.chateaya.app app.chateaya.app;

    # Let's Encrypt challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# ─── Landing Page (chateaya.app) ───
server {
    listen 443 ssl;
    server_name chateaya.app www.chateaya.app;

    ssl_certificate     /etc/letsencrypt/live/chateaya.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chateaya.app/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    client_max_body_size 50M;

    # Meta (Facebook/Instagram) webhooks & OAuth callbacks
    location /meta/ {
        proxy_pass http://backend:8080/meta/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend API (for external services like Stripe webhooks)
    location /api/ {
        proxy_pass http://backend:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 50M;
    }

    # Plans API (public - used by landing page pricing section)
    location /plans/ {
        proxy_pass http://backend:8080/plans/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Public files (media uploaded by users)
    location /public/ {
        proxy_pass http://backend:8080/public/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Landing page (static HTML)
    location / {
        proxy_pass http://landing:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# ─── Frontend App (app.chateaya.app) ───
server {
    listen 443 ssl;
    server_name app.chateaya.app;

    ssl_certificate     /etc/letsencrypt/live/chateaya.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chateaya.app/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    client_max_body_size 50M;

    # ── Backend API routes ──
    # All backend Express routes (auth, users, contacts, tickets, etc.)
    # are mounted at root level without /api/ prefix, so we proxy each prefix to the backend.
    location ~ ^/(auth|users|settings|contacts|tickets|ticket-notes|ticket-tags|whatsapp|whatsappsession|messages|api/messages|queue|queue-options|queueIntegration|companies|companiesPlan|plans|quick-messages|helps|dashboard|schedules|tags|contact-lists|contact-list-items|campaigns|campaign-settings|announcements|chats|invoices|subscription|files|prompt|forgetpassword|resetpasswords|flowdefault|flowbuilder|flowcampaign|meta-connections|meta|meta-messages|ultramsg-config|email-config|email-campaigns|shopify-connections|shopify)(/|$) {
        resolver 127.0.0.11 valid=30s;
        proxy_pass $backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 50M;
    }

    # WebSocket (Socket.IO)
    location /socket.io/ {
        proxy_pass http://backend:8080/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # Public files (media uploaded by users)
    location /public/ {
        proxy_pass http://backend:8080/public/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Frontend (React App) - fallback for all other routes (SPA)
    location / {
        proxy_pass http://frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
